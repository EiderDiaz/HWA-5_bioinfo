---
title: "Statistical Tests BioInfo"
author: "eider"
date: "3/27/2020"
output:
  html_document: default
  pdf_document: default
---


# Statistical Tests BioInfo

Obtain p-values with the t-test, Wilcoxon test, and Kolmogorov-Smirnov test for Two vectors of normally distributed data (generated with rnorm) with different means and two vectors of uniformly distributed data (generated with runif) with different means, plot the results and compare. 


```{r setup, echo=FALSE }
library(ggplot2)
set.seed(42)
```

## Create two normal distributions

```{r, echo=FALSE }
D1 <- rnorm(n=100,mean=8,sd=1)
D2 <- rnorm(n=100,mean=10,sd=1)

```


## perform T-test, Wilcolxon, and Kolmogorov statistical test 


```{r test, echo=FALSE}
t_test <- t.test(D1,D2)
wilcx_test <- wilcox.test(D1,D2)
ks_test <- ks.test(D1,D2,alternative = "two.sided")

```

## print out each pvalue obtained from the aforementioned statistical test 
```{r, echo=FALSE }
t_test$p.value
wilcx_test$p.value
ks_test$p.value
```


# plot the distributions 

```{r , echo=FALSE }

combined_D1D2 <-data.frame( x=c(D1,D2))


  ggplot(combined_D1D2) +
  geom_histogram(aes(x = x,y= ..density..),bins = 30)+
  stat_function(geom = "line", fun = dnorm,
                args = list(mean = 8, sd=1))+ 
    stat_function(geom = "line", fun = dnorm,
                args = list(mean = 10, sd=1)) 

 


```


## two uniforms from 42 to 60 and 48 to 66

```{r, echo=FALSE }

D3 <- runif(100, 42, 60)
D4 <- runif(100, 48, 66)

```


## test 
```{r, echo=FALSE }
t_test2 <- t.test(D3,D4)
wilcx_test2 <- wilcox.test(D3,D4)
ks_test2 <- ks.test(D3,D4,alternative = "two.sided")

```



## print out each pvalue obtained from the aforementioned statistical test 
```{r, echo=FALSE }
t_test2$p.value
wilcx_test2$p.value
ks_test2$p.value
```


we can observe in the histogram that values generated with runif are not normal distributed and relatively low p-values for the 3 test , on the other hand the values generated by rnorm give us gaussian distributions and p-values low for t and wilcox test and 0 for Kolmogorov.

```{r}

fun_gaussian<- function(x, mean, proportion, sd){
  proportion * dnorm(x, mean, sd )
}


  ggplot(data.frame(x=D3)) +
  geom_histogram(aes(x = x,y= ..density..),bins = 10)+
  stat_function(geom = "line", fun = fun_gaussian  ,
                args = list(mean = 50, sd=1, proportion=0.3))



 ggplot(data.frame(D4)) +
  geom_histogram(aes(x = D4,y= ..density..),bins = 10)+
   stat_function(geom = "line", fun = fun_gaussian  ,
                args = list(mean = 55, sd=1, proportion=0.3))
 

```






# statitistic test on GEO database

Obtain p-values with a t-test, Wilcoxon test, Kolmogorov-Smirnov test, and SAM with the selected GEO dataset 
```{r, echo=FALSE}
#Install packages from Bioconductor as they're not available in CRAN
if (!requireNamespace("BiocManager", quietly=TRUE))
install.packages("BiocManager")
BiocManager::install("biomaRt")
BiocManager::install(c("GEOquery", "limma","Biobase","affy", "quantro"))

library(GEOquery)
library(limma)
library(Biobase)
library(affy)
library(quantro)
library(tidyr)
library(preprocessCore )
```

## load GEO Dataset
```{r, echo=FALSE}
# Genomic signature of the standardized uptake value in 18F-fluorodeoxyglucose positron emission tomography in breast cancer

#GSE121378
gset_BRCA <- getGEO("GSE131769")
BRCA <- gset_BRCA[[1]]
#get the phenotype and expression and save it
phenotype_data <- pData(phenoData(BRCA))
expressions <- exprs(BRCA)
#expressions gives null observations 
# i tried to use different dataser from Breast cancer but every one give me null expressions

```



#since the BRCA expression gives null observations only i will use another dataset 
```{r, echo=FALSE}
gset<-getGEO("GSE50834")

gset <- gset[[1]]
phenotype_data <- pData(phenoData(gset))
expressions <- exprs(gset)

expressions[is.na(expressions)] =0


write.csv(phenotype_data, "./phenotypedata_GSE50834.csv")
write.csv(expressions, "./expression_data_GSE50834.csv")



```

## write and read data in order to perfrorm one query

```{r, echo=FALSE}
phenotype_data <- read.csv("./phenotypedata_GSE50834.csv")
expressions <- read.csv("./expression_data_GSE50834.csv")

compare_groups <- gsub(pattern="disease state: ", replacement="", as.character(pData(phenoData(gset))[12][,1]))
```

## log2 tranformation and tidying nulls

```{r, echo=FALSE, include=FALSE}
#ex_log2 <- log2(expressions+1)
#ex_log2[is.na(ex_log2)] <- 0
#save(ex_log2,file="./ex_log2.RDATA")
#save(expressions,file="./expressions.RDATA")

```
## plot both densities

```{r, echo=FALSE}
load("./ex_log2.RDATA")
load("./expressions.RDATA")

par(mfrow=c(1,2))
plot(density(expressions))
plot(density(ex_log2))
```


## Perform t-test, Wilcoxon, and KS over the GEO dataset
```{r, echo=FALSE}
vd_ctrl_ttest <- apply(expressions, 1, function(x) {
  aux <- t.test(x[which(compare_groups == "HIV/TB")], 
                x[which(compare_groups == "HIV only")]);
  aux$p.value
})

vd_ctrl_wilcox <- apply(expressions, 1, function(x) {
  aux <- wilcox.test(x[which(compare_groups == "HIV/TB")],
                     x[which(compare_groups == "HIV only")]);
  aux$p.value
})




vd_ctrl_KS <- apply(expressions, 1, function(x) {
  aux <- ks.test(x[which(compare_groups == "HIV/TB")], x[which(compare_groups == "HIV only")]);
  aux$p.value
})



#ttest
test_ex <- data.frame(vd_ctrl_ttest)
colnames(test_ex) <- "pvalue"
test_ex[,"test"] <- "t-test"
head(test_ex)

# wilcox
Wil_ex <- data.frame(vd_ctrl_wilcox)
colnames(Wil_ex) <- "pvalue"
Wil_ex[,"test"] <- "wilcoxon"

# KS
KS_ex <- data.frame(vd_ctrl_KS)
colnames(KS_ex) <- "pvalue"
KS_ex[,"test"] <- "KS"

all_raw_expsr_test <- rbind(test_ex,Wil_ex,KS_ex)

density_exprs_plot <- ggplot(all_raw_expsr_test, aes(x=pvalue, color=test, group=test)) + geom_density() + xlab("P-Value") + ylab("Density") + 
  labs(title="HIV vs. HIV/TB Raw Expression ", color="Test") 

density_exprs_plot

```


# Qnormalized set
```{r, echo=FALSE}
expressions_qn <- normalize.quantiles(expressions) 

vd_ctrl_ttest <- apply(expressions_qn, 1, function(x) {
  aux <- t.test(x[which(compare_groups == "HIV/TB")], x[which(compare_groups == "HIV only")]);
  aux$p.value
})


vd_ctrl_wilcox <- apply(expressions_qn, 1, function(x) {
  aux <- wilcox.test(x[which(compare_groups == "HIV/TB")], x[which(compare_groups == "HIV only")]);
  aux$p.value
})


vd_ctrl_KS <- apply(expressions_qn, 1, function(x) {
  aux <- ks.test(x[which(compare_groups == "HIV/TB")], x[which(compare_groups == "HIV only")]);
  aux$p.value
})

#ttest
test_ex <- data.frame(vd_ctrl_ttest)
colnames(test_ex) <- "pvalue"
test_ex[,"test"] <- "t-test"
head(test_ex)

# wilcox
Wil_ex <- data.frame(vd_ctrl_wilcox)
colnames(Wil_ex) <- "pvalue"
Wil_ex[,"test"] <- "wilcoxon"

# KS
KS_ex <- data.frame(vd_ctrl_KS)
colnames(KS_ex) <- "pvalue"
KS_ex[,"test"] <- "KS"

all_qn_expsr_test <- rbind(test_ex,Wil_ex,KS_ex)

density_qn_exprs_plot <- ggplot(all_qn_expsr_test, aes(x=pvalue, color=test, group=test)) + geom_density() + xlab("P-Value") + ylab("Density") + 
  labs(title="HIV vs. HIV/TB Quantile Normalized Expressions ", color="Test") 

density_qn_exprs_plot



```


## SAM method

```{r, echo=FALSE}
library(siggenes)
library(multtest)
ex_sam <- sam(expressions, compare_groups, method = "d.stat",
              gene.names = colnames(expressions))

p.val_ex <- ex_sam@p.value
length(p.val_ex)

#show SAM results in 1.9 delta value
ex_sam_sum <- summary(ex_sam,1.9)
sig_ex <- data.frame(ex_sam_sum@mat.sig)

head(ex_sam@p.value,10)





```


## concluir 
